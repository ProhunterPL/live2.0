# Live 2.0 - Prebiotic Chemistry Simulation Project
# =================================================
# Cursor AI Rules for navigating this complex codebase

## üéØ Project Overview

**Purpose**: AI-powered particle simulation for origin-of-life chemistry research
**Tech Stack**: Python + Taichi (GPU/CPU compute), React frontend, FastAPI backend
**Scale**: 500K+ step simulations, 1000-2000 particles, molecular detection & analysis

## üìÅ Critical Project Structure

```
live2.0/
‚îú‚îÄ‚îÄ backend/sim/              # Core simulation engine (MOST IMPORTANT)
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stepper.py       # Main simulation loop, step() function
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binding.py       # Bond formation/breaking (Taichi kernels)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ particles.py     # Particle state & physics
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grid.py          # Spatial hashing for performance
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ catalog.py       # Molecule detection & tracking
‚îÇ   ‚îú‚îÄ‚îÄ chemistry/           # Chemical rules & reactions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ physics_db.py    # Periodic table, bond energies
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reactions.py     # Reaction detection & validation
‚îÇ   ‚îú‚îÄ‚îÄ config.py            # Simulation configuration (SimulationConfig)
‚îÇ   ‚îî‚îÄ‚îÄ molecule_extractor.py # Post-processing: extract molecules from snapshots
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ run_phase2_full.py   # Main runner for Phase 2 simulations
‚îÇ   ‚îî‚îÄ‚îÄ analyze_results.py   # Results analysis & molecule extraction
‚îÇ
‚îú‚îÄ‚îÄ aws_test/                # AWS deployment & monitoring
‚îÇ   ‚îú‚îÄ‚îÄ configs/             # YAML configs for different scenarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ *_SUPER_FAST.yaml  # Production configs (cluster_check_interval: 999999999)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ phase2_*.yaml      # Scenario definitions (miller_urey, hydrothermal, formamide)
‚îÇ   ‚îî‚îÄ‚îÄ scripts/
‚îÇ       ‚îú‚îÄ‚îÄ auto_queue_restart.sh      # Auto-restart system (4 parallel max)
‚îÇ       ‚îú‚îÄ‚îÄ check_actual_progress.py   # Progress monitoring
‚îÇ       ‚îî‚îÄ‚îÄ kill_stuck_phase2b.sh      # Emergency cleanup
‚îÇ
‚îú‚îÄ‚îÄ results/                 # Simulation outputs
‚îÇ   ‚îî‚îÄ‚îÄ phase2b_additional/
‚îÇ       ‚îî‚îÄ‚îÄ miller_urey_extended/
‚îÇ           ‚îî‚îÄ‚îÄ run_X/       # Each run has: results.json, molecules.json, snapshots/, checkpoints/
‚îÇ
‚îî‚îÄ‚îÄ docs/                    # Documentation
    ‚îú‚îÄ‚îÄ CLUSTER_DEADLOCK_FIX.md       # Cluster detection issue & fix
    ‚îî‚îÄ‚îÄ aws_test/AUTO_RESTART_GUIDE.md # AWS deployment guide
```

## üî• Critical Files (Read These First!)

1. **`backend/sim/core/stepper.py`** (1642 lines)
   - Line 507-518: Cluster detection (FIXED - now reads from config)
   - Line 335-440: Main simulation loop
   - Line 422-440: Checkpoint/snapshot saving

2. **`backend/sim/config.py`**
   - `SimulationConfig` class: All simulation parameters
   - `cluster_check_interval`: Set to 999999999 to disable (prevents deadlock)

3. **`scripts/run_phase2_full.py`**
   - `Phase2FullRunner` class: Orchestrates full simulation runs
   - Creates snapshots (every 50K steps) & checkpoints (every 100K)

4. **`aws_test/configs/*_SUPER_FAST.yaml`**
   - Production configs for AWS
   - **CRITICAL**: Must have `cluster_check_interval: 999999999`

## ‚ö†Ô∏è Known Issues & Solutions

### Issue 1: Cluster Detection Deadlock (FIXED)
**Problem**: O(N¬≤) cluster detection causes infinite loop in complex networks
**Location**: `backend/sim/core/stepper.py` line 510
**Fix Applied**: Reads `cluster_check_interval` from config instead of hardcoded 1200
**Config Fix**: Set `cluster_check_interval: 999999999` in all SUPER_FAST configs
**Impact**: Chemistry still accurate, only cluster metrics disabled

### Issue 2: Empty Molecule Catalog (Post-Processing Fix)
**Problem**: Catalog not updated during simulation ‚Üí empty molecules.json
**Location**: `backend/sim/core/catalog.py`
**Solution**: Use `molecule_extractor.py` to extract from snapshots post-simulation
**Script**: `scripts/fix_run1_molecules.py`

### Issue 3: Checkpoints Don't Resume
**Problem**: Checkpoints are markers only, not full state
**Location**: `scripts/run_phase2_full.py` line 434
**Workaround**: Restart from beginning (queue system handles this)

## üöÄ Common Operations

### 1. Run Single Simulation (Local)
```bash
python3 scripts/run_phase2_full.py \
    --config aws_test/configs/phase2_miller_urey_extended_SUPER_FAST.yaml \
    --output results/test_run \
    --seed 100 \
    --steps 500000 \
    --force-cpu
```

### 2. Run Phase 2B on AWS (Multiple Parallel)
```bash
# Start auto-restart queue system (4 parallel max)
cd ~/live2.0
nohup bash aws_test/scripts/auto_queue_restart.sh > logs/auto_restart_main.log 2>&1 &

# Monitor progress
python3 aws_test/scripts/check_actual_progress.py
```

### 3. Extract Molecules from Completed Run
```python
from backend.sim.molecule_extractor import extract_molecules_from_results
results = extract_molecules_from_results("results/phase2b_additional/miller_urey_extended/run_1")
```

### 4. Analyze Results
```bash
python3 aws_test/scripts/analyze_additional_results.py
```

## üé® Code Conventions

### Python
- **Taichi kernels**: Use `@ti.kernel` decorator, all args must be typed
- **Config access**: Use `getattr(self.config, 'param_name', default_value)`
- **Logging**: Use module-level logger: `logger = logging.getLogger(__name__)`
- **Type hints**: Required for all function signatures

### YAML Configs
- **Structure**: `simulation:`, `physics:`, `chemistry:`, `initial_molecules:`
- **Required fields**: `n_particles`, `max_steps`, `dt`, `box_size`
- **Critical params**:
  - `cluster_check_interval: 999999999` (disable cluster detection)
  - `bond_check_interval: 200` (bond updates)
  - `novelty_check_interval: 99999999` (disable novelty detection)

### File Naming
- Configs: `phase2_<scenario>_<mode>.yaml` (e.g., `phase2_miller_urey_extended_SUPER_FAST.yaml`)
- Results: `run_<number>/` (e.g., `run_1/`, `run_2/`)
- Scripts: `<action>_<target>.py` or `.sh`

## üîç How to Find Things

### "Where is X defined?"
- **Particle physics**: `backend/sim/core/particles.py`
- **Bond rules**: `backend/sim/chemistry/physics_db.py`
- **Reactions**: `backend/sim/chemistry/reactions.py`
- **Config schema**: `backend/sim/config.py`
- **Main loop**: `backend/sim/core/stepper.py` ‚Üí `step()` method
- **Molecule detection**: `backend/sim/core/catalog.py`

### "How does X work?"
- **Simulation step**: `stepper.py` ‚Üí `step()` ‚Üí calls binding, reactions, energy, etc.
- **Bond formation**: `binding.py` ‚Üí `check_and_form_bonds_kernel()` (Taichi kernel)
- **Molecule extraction**: `molecule_extractor.py` ‚Üí analyzes bond graph from snapshots
- **Auto-restart**: `aws_test/scripts/auto_queue_restart.sh` ‚Üí monitors & queues runs

### "What does config parameter X do?"
1. Search in `backend/sim/config.py` for field definition
2. Search codebase for `getattr(self.config, 'X'` to see usage
3. Check YAML examples in `aws_test/configs/`

## üìä Phase 2B Status (Current)

### Active State
- **Running**: 4 simulations (runs 5-8) at ~336K/500K steps
- **Queue**: 12 simulations waiting (runs 2-4, 10-18)
- **Completed**: 1 simulation (run_1)
- **System**: Auto-restart queue managing 4 parallel max

### Timeline
- T+0h: Runs 5-8 active (67% done)
- T+8h: Runs 5-8 complete ‚Üí start 2-4, 10
- T+16h: Start runs 11-14
- T+24h: Start runs 15-18
- T+32h: All 17 runs complete

### Files Changed for Fix
1. `backend/sim/core/stepper.py` - cluster_check_interval configurable
2. `aws_test/configs/*_SUPER_FAST.yaml` - cluster detection disabled
3. `aws_test/scripts/auto_queue_restart.sh` - queue management system

## üéØ When Editing Code

### Before Creating New Files/Directories
1. **Check for existing similar files**: Before creating a new script, test, or document, search the codebase for similar or identical files that can be reused or extended
2. **Check for existing directories**: Before creating a new directory, verify if a similar or identical directory already exists that can be used
3. **Search before creating**: Use `grep`, `glob_file_search`, or `codebase_search` to find existing similar functionality
4. **Reuse over recreate**: Always prefer extending existing files over creating duplicates
5. **Examples**:
   - Before creating `analyze_X.py`, check if `analyze_results.py` or similar exists
   - Before creating `docs/X.md`, check `docs/` for similar documentation
   - Before creating `scripts/test_X.py`, check `tests/` and `scripts/` for existing tests

### Before Modifying Simulation Core
1. **Check if Taichi kernel**: Cannot use Python stdlib inside `@ti.kernel`
2. **Test locally first**: Run 1000 steps before AWS deployment
3. **Watch for deadlocks**: Any O(N¬≤) operation on particles is dangerous
4. **Profile performance**: Use `time_step` in logs to detect slowdowns

### Before Changing Configs
1. **Validate YAML syntax**: Use yamllint or online validator
2. **Check required fields**: `simulation.n_particles`, `max_steps`, `dt`
3. **Test with small run**: 10K steps locally before 500K on AWS
4. **Backup old config**: Copy to `*_BACKUP.yaml` before changes

### Before Deploying to AWS
1. **Commit & push locally**: Git is source of truth
2. **Pull on AWS**: `git pull origin main` before running
3. **Check running processes**: Don't exceed 4 parallel
4. **Monitor first 10 minutes**: Ensure no immediate crashes

## üêõ Debugging Tips

### Simulation Stuck/Slow
- Check `simulation.log` for last timestamp
- Look for "sleeping" state: `ps aux | grep run_phase2_full.py`
- If high CPU + no progress ‚Üí cluster detection deadlock (kill & restart)
- If low CPU ‚Üí waiting for I/O or deadlock in Python

### No Molecules Detected
- Check snapshots exist: `ls results/*/run_X/snapshots/`
- Use extractor: `molecule_extractor.py` to post-process
- Verify bonds exist in snapshot JSON: look for `bonds` array
- Check catalog was enabled in config (but often empty - use extractor)

### Out of Memory (OOM)
- Reduce parallel runs: 4 ‚Üí 2
- Check swap: `free -h`
- Look for memory leak: `top` sorted by memory
- Reduce `n_particles` in config

### Results Analysis Fails
- Ensure `results.json` exists (simulation completed)
- Check `molecules.json` not empty (use extractor if needed)
- Verify snapshots have bond data
- Look for errors in `simulation.log`

## üîê Security & Best Practices

1. **Never commit AWS credentials**: Use environment variables
2. **Always use virtual env**: Isolate Python dependencies
3. **Check disk space before runs**: 500K steps = ~1-2 MB per run
4. **Monitor AWS costs**: Stop instances when not needed
5. **Backup results regularly**: SCP to local before terminating instance

## üìö Documentation Standards & Locations

### Documentation Organization Rules
1. **All documentation files (*.md) MUST be in `docs/` directory or subdirectories**
   - Never create .md files in project root (except README.md)
   - Never create .md files in `aws_test/` or `scripts/`
   - Organize by topic: `docs/aws_test/`, `docs/local/`, `docs/phase2b/`, etc.

2. **Documentation Header Format (REQUIRED)**
   Every .md file must start with this header:
   ```markdown
   ---
   date: YYYY-MM-DD
   label: [manual|fix|guide|analysis|summary|status]
   ---
   # Document Title
   ```
   
   Labels explained:
   - `manual`: User guides, how-to documents
   - `fix`: Bug fixes, problem solutions
   - `guide`: Step-by-step instructions
   - `analysis`: Analysis reports, investigations
   - `summary`: Session summaries, progress reports
   - `status`: Current state, status updates

3. **File Naming Conventions**
   - Use UPPERCASE_WITH_UNDERSCORES.md for important docs
   - Use descriptive names: `HYDROTHERMAL_QUEUE_GUIDE.md` not `guide.md`
   - Include date in filename for session notes: `SESSION_2025_11_19.md`

### Documentation Locations

- **Setup**: `README.md` (project root only exception)
- **AWS deployment**: `docs/aws_test/`
  - AUTO_RESTART_GUIDE.md - Queue system guide
  - CLUSTER_DEADLOCK_FIX.md - Cluster detection fix
  - HYDRO_QUEUE_AWS_READY.md - Hydrothermal deployment
- **Local development**: `docs/local/`
  - HYDROTHERMAL_QUEUE_GUIDE.md - Local queue guide
  - HYDRO_CPU_OPTIMIZED_READY.md - CPU optimization
- **Phase-specific**: `docs/phase2b/`, `docs/phase3/`, etc.
  - HYDRO_DEPLOYMENT_SUMMARY.md - Deployment summary
  - SCIENTIFIC_VALIDITY_ANALYSIS.md - Scientific analysis
- **Session notes**: `docs/sessions/` (historical context)
- **Technical docs**: `docs/technical/`
  - BOTTLENECK_ANALYSIS.md - Performance analysis
  - JAK_NAPRAWIC_CHEMIE.md - Chemistry fixes
  - PROBLEM_NIEREALISTYCZNE_CZASTECZKI.md - Molecule issues
- **Validation**: `docs/VALIDATION_ROADMAP.md`

## ‚ö° Performance Notes

- **Taichi GPU**: 10-50x faster than CPU but has memory limits
- **CPU mode**: More stable, use for long runs (500K steps)
- **Snapshot interval**: 50K steps = ~10 snapshots per run
- **Checkpoint interval**: 100K steps = ~5 checkpoints (not restorable yet)
- **Expected speed**: 4-8 steps/sec on CPU, 40-200 steps/sec on GPU
- **Memory usage**: ~2-4 GB per simulation process

## üéì Key Concepts

### Particle Attributes
- **Element**: Atomic number (1=H, 6=C, 7=N, 8=O, 16=S)
- **Position**: (x, y, z) in box_size grid
- **Velocity**: (vx, vy, vz) in simulation units
- **Bonds**: List of bonded particle indices
- **Active**: Boolean flag (particle exists)

### Bond Rules
- **Distance threshold**: < 2.3 √Ö typically
- **Energy check**: Bond must be energetically favorable
- **Valence check**: Cannot exceed max bonds for element
- **Break threshold**: High kinetic energy or large separation

### Molecule Detection
- **Bond graph**: Build graph from particle bonds
- **Connected components**: Find clusters of bonded particles
- **SMILES generation**: Convert to chemical notation
- **Novel detection**: Compare against known database

## üö¶ When to Ask User

- **Changing core algorithms**: Affects scientific validity
- **Modifying configs for AWS runs**: Cost implications
- **Deleting/moving large result files**: Data loss risk
- **Installing new dependencies**: Environment changes
- **Committing to main branch**: Production code
- **Stopping running simulations**: Progress loss

## üéØ Project Goals

**Current Phase**: Phase 2B - Additional 30 runs for statistical validation
**Target**: 17-30 miller_urey runs @ 500K steps each
**Timeline**: ~32 hours to completion with auto-restart system
**Next Phase**: Phase 3 - Analysis & paper writing
**Publication Goal**: Show autocatalytic cycles & novel molecule formation

---

**Last Updated**: 2025-11-12
**Agent Context**: Use this file to understand project structure, avoid common pitfalls, and navigate the codebase efficiently.

